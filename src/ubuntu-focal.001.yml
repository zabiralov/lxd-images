---

# Time-stamp: <2021-06-12 00:44:34 azabiralov>

image:
  distribution: ubuntu
  release: focal
  architecture: x86_64

source:
  downloader: debootstrap
  url: https://mirror.yandex.ru/ubuntu/
  keyserver: keyserver.ubuntu.com
  keys:
    - 0x790BC7277767219C42C86F933B4FE6ACC0B21F32
    - 0xf6ecb3762474eda9d21b7022871920d1991bc93c

targets:
  lxc:
    create-message: |
        You just created a {{ image.description }} container.

    config:
      - type: all
        before: 5
        content: |-
          lxc.include = LXC_TEMPLATE_CONFIG/ubuntu.common.conf

      - type: user
        before: 5
        content: |-
          lxc.include = LXC_TEMPLATE_CONFIG/ubuntu.userns.conf

      - type: all
        after: 4
        content: |-
          lxc.include = LXC_TEMPLATE_CONFIG/common.conf

      - type: user
        after: 4
        content: |-
          lxc.include = LXC_TEMPLATE_CONFIG/userns.conf

      - type: all
        content: |-
          lxc.arch = {{ image.architecture_kernel }}

files:
  - name: hostname
    path: /etc/hostname
    generator: template
    content: |-
      {{ container.name }}.example.com

  - name: hosts
    path: /etc/hosts
    generator: hosts


  - name: 02recommends
    path: /etc/apt/apt.conf.d/02recommends
    generator: dump
    content: |-
      APT::Install-Recommends "false";
      APT::Install-Suggests "false";


  - name: sshd_config
    path: /etc/ssh/sshd_config
    generator: dump
    content: |-
      AcceptEnv                         LANG LC_*
      AddressFamily                     any
      AllowAgentForwarding              yes
      AllowTcpForwarding                yes
      ChallengeResponseAuthentication   no
      GSSAPIAuthentication              no
      GatewayPorts                      yes
      KerberosAuthentication            no
      ListenAddress                     0.0.0.0
      ListenAddress                     ::
      MaxAuthTries                      6
      MaxSessions                       10
      PasswordAuthentication            no
      PasswordAuthentication            no
      PermitEmptyPasswords              no
      PermitRootLogin                   no
      Port                              22
      PrintLastLog                      yes
      PrintMotd                         yes
      PubkeyAuthentication              yes
      StrictModes                       no
      Subsystem	                        sftp /usr/lib/openssh/sftp-server
      TCPKeepAlive                      yes
      UseDNS                            no
      UsePAM                            yes
      X11Forwarding                     no


packages:
  manager: apt
  update: true
  cleanup: true
  sets:
    - packages:
      - bash-completion
      - dnsutils
      - inetutils-ping
      - iproute2
      - less
      - lsof
      - man
      - man-db
      - ncdu
      - nmap
      - tcpdump
      - vim

      action: install

actions:
  - trigger: post-packages
    action: |-
      #!/bin/sh
      #
      echo '--------------------------'
      echo 'start post-packages script'
      echo '--------------------------'

      set -eux
      
      # Disable password for root
      passwd -d root

      set +x

      echo '-----------------------------'
      echo 'post-packages script complete'
      echo '-----------------------------'
